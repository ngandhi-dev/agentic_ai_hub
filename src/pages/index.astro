---
import Hero from "../components/Hero.astro";
import Header from "../components/Header.astro";
import Footer from '../components/footer.astro'
// Import ProcessGrid
import ProcessGrid from '../components/ProcessGrid.astro';
// IMport SourceMonitor
import SourceMonitor from '../components/SourceMonitor.astro';
// Import InsideIssue
import InsideIssue from '../components/InsideIssue.astro';
// Import TrustSection section
import TrustSection from '../components/TrustSection.astro'
// Import Testimonial section
import FooterCTA from '../components/FooterCTA.astro'
import Layout from '../layouts/Layout.astro';
import { supabase } from '../lib/supabase';
import { getCollection } from 'astro:content';
// 1. Fetch Top 3 most visited paths from Supabase
const { data: topVisits, error } = await supabase
  .from('site_visits')
  .select('page_path, visit_count')
  .order('visit_count', { ascending: false })
  .limit(3);

// 2. Fetch all local issues to match the titles
const allIssues = await getCollection('pulse');

// 3. Match them up
const trendingIssues = topVisits?.map(visit => {
  const match = allIssues.find(issue => `/pulse/${issue.slug}` === visit.page_path);
  return {
    ...visit,
    title: match?.data.title || "Latest Update",
    tag: match?.data.tag || "News"
  };
}).filter(item => item.title !== "Latest Update"); // Only show actual issue matches
---
<Header /> <!-- Use client:load for JS components -->

<section class="trending-section">
  <div class="container">
    <div class="trending-header">
      <span class="live-dot"></span>
      <h2>Trending Now</h2>
    </div>
    
    <div class="trending-grid">
      {trendingIssues && trendingIssues.map((issue, index) => (
        <a href={issue.page_path} class="trending-card">
          <span class="rank">0{index + 1}</span>
          <div class="trending-info">
            <span class="trending-tag">{issue.tag}</span>
            <h4>{issue.title}</h4>
            <div class="view-badge">
              <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
              {issue.visit_count} views
            </div>
          </div>
        </a>
      ))}
    </div>
  </div>
</section>

<Hero />
<ProcessGrid />
<SourceMonitor />
<InsideIssue />
<TrustSection />
<FooterCTA />
<Footer />

<style>
	.trending-header { display: flex; align-items: center; gap: 10px; margin-bottom: 2rem; }
  .live-dot { width: 8px; height: 8px; background: #ef4444; border-radius: 50%; box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.2); animation: pulse 2s infinite; }
  @keyframes pulse { 0% { transform: scale(0.95); opacity: 1; } 70% { transform: scale(1.1); opacity: 0.5; } 100% { transform: scale(0.95); opacity: 1; } }
  
  .trending-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
  .trending-card { display: flex; gap: 20px; padding: 20px; text-decoration: none; background: #f8fafc; border-radius: 16px; border: 1px solid transparent; transition: all 0.3s ease; }
  .trending-card:hover { border-color: #3b82f6; background: white; transform: translateX(5px); }
  
  .rank { font-size: 2rem; font-weight: 900; color: #e2e8f0; line-height: 1; }
  .trending-tag { font-size: 0.7rem; font-weight: 800; color: #3b82f6; text-transform: uppercase; }
  h4 { font-size: 1rem; color: #0f172a; margin: 4px 0 8px; line-height: 1.4; }
  .view-badge { display: flex; align-items: center; gap: 5px; font-size: 0.75rem; color: #64748b; font-weight: 600; }
</style>




